:doctype: book
ifndef::env-github[]
image::doc/Gematik_Logo_Flag_With_Background.png[logo,width=200,height=47,role=right]
endif::[]
ifdef::env-github[]
++++
<img align="right" width="250" height="47" src="doc/Gematik_Logo_Flag_With_Background.png"/> <br/>
++++
endif::[]

= KOB-Testsuite für DiGA

== Inhaltsverzeichnis

* <<_einführung,Einführung>>
* <<_setup,Setup>>
* <<_konfiguration,Konfiguration>>
* <<_routing,Routing>>
* <<_testausführung,Testausführung>>
* <<_port_tabelle,Port Tabelle>>

== Einführung

Dies ist eine prerelease Fassung der KOB-Testsuite, die die Konformitätsbestätigung der gematik für DiGA ermöglicht. Es handelt sich hierbei nicht um die finale Version, mit der eine tatsächliche Bestätigung ausgestellt werden kann!

== Setup

Die grundsätzlichen technischen Voraussetzungen sehen wie folgt aus:

image::/doc/img/setup.png[Setup]

* Die Testsuite wird auf einem Tester-PC ausgeführt.
* Auf diesem läuft auch das Primärsystem.
* Der Konnektor ist korrekt konfiguriert und erreichbar.
* Die eRezept Fachdienste in der RU sind erreichbar.
* Auf diesem Testrechner kann nun die Tiger-Testsuite gestartet werden, ebenso wie der Tiger-Proxy.
* Die Kommunikation zwischen Primärsystem und der TI muss nun über den Tiger-Proxy geleitet werden.
* Dieser kann die Kommunikation aufzeichnen und analysieren.
* Die Testsuite kann Artefakte von Maven Central aus dem Internet beziehen.

== Konfiguration

=== TLS Konfiguration

Der Tiger-Proxy unterstützt TLSv1.2 und gibt Server Zertifikate zurück, welche den Zertifikaten des Fachdienstes in der RU entspricht. Siehe folgende Datei:

* `erp-ref.app.ti-dienste.de_NIST_X509.p12`

Zusätzlich wurde die unterstützen CipherSuiten wie folgt eingeschränkt:

* `TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256`
* `TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384`

== Routing

Es muss das Routing der Nachrichten über Tiger-Proxy der KOB-Testsuite erfolgen, um eine Auswertung dieser zu ermöglichen. Der Tiger-Proxy sendet die Anfragen an den RU-Fachdienst weiter. Dazu muss eine geeignete Verbindung in die RU aufgebaut werden können (z.B. mittels lokalem RU-Konnektor). Wichtig ist hierbei auch, dass in dem äußeren HTTP-Request auch der HTTP-Header "Host" für die Anfrage an den entsprechenden Fachdienst gesetzt ist, damit Tiger-Proxy die Anfrage entsprechend nach dem Mitschnitt weiterleiten kann.

Beispiel für den HTTP-Header, damit Tiger-Proxy korrekt routen kann.
[source,httprequest]
----
Host: erp-dev.zentral.erp.splitdns.ti-dienste.de
----

Es gibt keine Vorgabe WIE diese Umleitung erfolgen muss, zwei Wege scheinen jedoch sinnvoll:

=== Forward Proxy (Variante 1)

In dieser Konfiguration kann die KOB-Testsuite als Forward-Proxy für das Primärsystem eingerichtet werden.
Die Routen sind entsprechend konfiguriert, damit der Verkehr hier an den DiGA-Mockserver weitergeleitet wird.

Hierbei sind folgende Punkte zu beachten:

* Primärsystem seitig wird die KOB-Testsuite als Proxy konfiguriert (e.g. `localhost:443`). Hiermit werden die Requests über die KOB-Testsuite an den DiGA-Mockserver gesendet. Ein Request an `https://erp-dev.zentral.erp.splitdns.ti-dienste.de/foobar`, via KOB-Testsuite mit `localhost:443` entspricht somit `curl -x localhost:443 erp-dev.zentral.erp.splitdns.ti-dienste.de/foobar`)
* Dabei ist darauf zu achten, dass der HTTP Header im (äußeren) HTTP Request dennoch den FQDN des Fachdienstes enthält (e.g `Host: erp-dev.zentral.erp.splitdns.ti-dienste.de`).
* Eine zusätzliche Manipulation der DNS Auflösung (Variante 2) in der `hosts` Datei ist nicht notwendig.

=== DNS Manipulation (Variante 2)

Alternativ kann die DNS-Auflösung beeinflusst werden, z.B. über das Editieren der Host-Einträge im Testsystem selbst (e.g. /etc/hosts). Hier werden die Hostnamen des Fachdienstes auf die IP-Adresse des Testrechners, wo der Tiger-Proxy mit dem Port 443 läuft, umgeleitet.

Beispiel, wenn das Primärsystem auf dem gleichen Rechner läuft, wie die Testsuite mit dem Tiger-Proxy:

[source,shell]
----
127.0.0.1    erp-dev.zentral.erp.splitdns.ti-dienste.de
127.0.0.1    erp-dev.app.ti-dienste.de
----
[IMPORTANT]
====
Diese Einträge sollten nach der Durchführung der KOB-Testsuite wieder entfernt werden, da es ansonsten zu einem unbeabsichtigten Fehlverhalten führt, wenn die KOB-Testsuite nicht mehr aktiv läuft und somit die Nachrichten nicht mehr an den DiGA-Mockserver weitergeleitet werden.
====

Damit der Tigerproxy die Nachricht am Ende an den RU-DEV Fachdienst schicken kann, müssen in der `.env` Datei die Umgebungsvariablen VAU_TRANSLATION_CLIENT_ERP_DEV_HOST und VAU_TRANSLATION_CLIENT_ERP_REF_HOST auskommentiert werden (siehe __Deactivate/Comment for DNS resolving via extra_hosts (e.g. when using DNS manipulation method)__ in `.env`).



=== Konfiguration von Git

Bei dem Checkout für eine lokale Kopie von dem Repository ist darauf zu achten, dass die Dateien nicht verändert werden durch ein Checkout selbst. Hierzu ist zu prüfen, dass folgenden Git Einstellungen (`.gitconfig`) für den Checkout des Repos genutzt werden:

[source]
----
[core]
  autocrlf = false
----

Dies kann mit folgenden Befehlen erreicht werden, je nachdem auf welcher Ebene die Einstellung getroffen werden soll:

[source, shell]
----
git config --system core.autocrlf false   # per-system solution
git config --global core.autocrlf false   # per-user solution
git config --local core.autocrlf false    # per-project solution
----


=== Proxy Konfiguration für Maven (Docker)

Da der KOB-Testsuite Container während der Ausführung Maven-Artefakte bezieht, muss das Internet für den Container erreichbar sein. Sollte das Internet nur über einen Proxy-Server erreichbar sein, müssen die Einstellungen in der [./settings.xml](./settings.xml) für die Ausführung des PS-Testsuite Containers angepasst werden. Bitte beachten Sie, dass der Parameter `<active>true</active>` gesetzt werden muss, um die Einstellungen zu aktivieren und das Docker-Volume `kob-testsuite-maven` gelöscht werden muss, um die Änderungen zu übernehmen.

Dazu müssen die folgenden Einträge angepasst werden:

[source,xml]
----
  <proxy>
    <id>optional</id>
    <active>true</active>
    <protocol>https</protocol>
    <host>proxy.example.com</host>
    <port>8080</port>
    <username>user</username>
    <password>password</password>
    <nonProxyHosts>localhost|127.0.0.1</nonProxyHosts>
  </proxy>
----

=== Konfiguration des Backends

Tiger kann entweder mit einem DiGA Mockserver betrieben werden oder den RU-DEV Fachdienst in der RU als Backend nutzen. Der Mockserver ist für lokale Tests und Entwicklung geeignet. Für die Bestätigung ist der RU-DEV Fachdienst auszuwählen. Die Einstellung dazu erfolgt in der `.env` Datei. Die Variable VAU_SERVER_TARGET_URL steuert dabei die Backendauswahl

 1. Mockserver (VAU_SERVER_TARGET_URL=http://kob-testsuite:8080), oder
 2. RU-DEV (VAU_SERVER_TARGET_URL=http://vauTranslationClient:8080) 

== Testausführung

Die KOB-Testsuite für DiGA kann nur in einem Docker-Container ausgeführt werden.
Per Default starten momentan die verpflichtenden KOB-Testfälle.

=== Lokal (Docker)

Die Testsuite kann mit einem Docker-Compose gestartet werden.

[source,bash]
----
docker compose -f dc-testsuite.yml up --abort-on-container-exit
----

[IMPORTANT]
====
Nach jeder Änderung im Git-Repository (Branchwechsel, pull oder Update der Quelldateien im /src Ordner) muss ein 
[source,bash]
----
docker compose -f dc-testsuite.yml build
----
ausgeführt werden, um die Änderungen zu übernehmen.
====



=== WorkflowUI

Die Durchführung der Testsuite geschieht über die von der KOB-Testsuite bereitgestellte Webseite der WorkflowUI.
Hierzu wird die folgende Adresse im Browser aufgerufen, wenn sich die Testsuite auf dem lokalen Rechner gestartet wurde: http://localhost:9010.
Beim Starten als Docker Container wird der entsprechende Link im Log ausgegeben, sobald die Seite aufrufbar ist.

[source,bash]
----
========================================================================================================================
  ____ _____  _    ____ _____ ___ _   _  ____  __        _____  ____  _  _______ _     _____        __  _   _ ___
 / ___|_   _|/ \  |  _ \_   _|_ _| \ | |/ ___| \ \      / / _ \|  _ \| |/ /  ___| |   / _ \ \      / / | | | |_ _|
 \___ \ | | / _ \ | |_) || |  | ||  \| | |  _   \ \ /\ / / | | | |_) | ' /| |_  | |  | | | \ \ /\ / /  | | | || |
  ___) || |/ ___ \|  _ < | |  | || |\  | |_| |   \ V  V /| |_| |  _ <| . \|  _| | |__| |_| |\ V  V /   | |_| || |   _ _ _
 |____/ |_/_/   \_\_| \_\|_| |___|_| \_|\____|    \_/\_/  \___/|_| \_\_|\_\_|   |_____\___/  \_/\_/     \___/|___| (_|_|_)

========================================================================================================================
09:21:12.065 [main ] INFO  d.g.t.t.l.TigerDirector - Waiting for workflow Ui to fetch status...
09:21:12.065 [main ] INFO  d.g.t.t.l.TigerDirector - Workflow UI http://localhost:9010
----

Nachdem der Testfall gestartet wurde, wartet die Testdurchführung auf eine Benutzerinteraktion, um mit der Prüfung der mitgeschnittenen Nachrichten vorzufahren. D.h. das in diesem Moment die DiGA Verordnung erstellt werden muss, *bevor* man die Testdurchführung fortführt. Für die anderen Testfälle wird ebenfalls in der UI jeweils darauf gewartet, dass die entsprechenden UseCases vom Primärsystem ausgeführt wurden.

image::/doc/img/continue_dialog_testsuite_diga.png[Continue Dialog in Testsuite]

== Port Tabelle

|=====================================================
| Service                      | Port | Protocol
| Tiger Testsuite (WorkflowUI) | 9010 | http
| Tiger-Proxy Admin Port       | 9011 | http
| Tiger-Proxy Proxy Port       | 443  | http / https
|=====================================================

=== Testreport

Die Testergebnisse selbst werden unter `./report` als zip Datei abgelegt, wenn die Ausführung über den Quit Button in der WorkflowUI beendet wird.

=== Testreport aus Docker Container

Um diese Datei aus dem Docker Container in das lokale System zu kopieren, kann folgender Befehl genutzt werden:

[source,bash]
----
docker cp kob-testsuite:/app/report/kob-testsuite-test-report.zip .
----

Eine weitere Möglichkeit ist, die Report ZIP Datei über die Anwendung DockerDesktop herunterzuladen.


== Troubleshooting / FAQs

=== Starten der Testsuite (Docker)

==== java.nio.file.AccessDeniedException: /.m2/repository/org

Der Zugriff auf das Docker Volume schlägt fehl.

*Variante 1*

Das Volume mit der gleichen Bezeichnung schon existiert und wurde von einer  anderen, möglicherweise älteren, Version der KOB-Testsuite erstellt wurde.
Man muss das Volume einmal löschen und bei Start der neuen Testsuite wird es wieder angelegt.

[source]
----
$> docker compose -f dc-testsuite.yml rm
$> docker volume rm -f kob-testsuite-maven
$> docker compose -f dc-testsuite.yml up
----

*Variante 2 (Linux)*

Bitte prüfen Sie vor dem Start der Testsuite, ob Sie das `.docker` Verzeichnis löschen können und starten sie die Testsuite im Anschluss noch einmal.

*Variante 3 (ohne Docker Volume)*

Eine weitere Möglichkeit ist auf die Nutzung des Docker Volume zu verzichten. Der Nachteil hierbei ist, dass die Maven Artefakte bei jedem Start der Testsuite erneut heruntergeladen werden müssen, was mehr Zeit in Anspruch nimmt. Hierzu wird die Zeile `- kob-testsuite-maven:/.m2` wie folgt mit einem Hash (#) auskommentiert.

[source]
----
    volumes:
      - ./tiger.yaml:/app/tiger.yaml
      - ./kob.yaml:/app/kob.yaml
      #- kob-testsuite-maven:/.m2
      # has to be 'copied' AFTER the volume is mounted
      - ./settings.xml:/.m2/settings.xml
----

=== Ausführen der Tests / fehlschlagende Tests

Im Falle eines fehlgeschlagenen Testlaufs und dem Schreiben eines Support-Tickets im gematik Service Desk ist es sinnvoll, die *.tgr-Datei mit den aufgezeichneten Nachrichten anzuhängen. Damit ist es möglich, die Traces in eine lokale Tiger-Anwendung zu importieren, um die Kommunikation und deren Meldungsdetails anzuzeigen.

Dazu müssen Sie den folgenden Befehl ausführen, um die *.tgr aus dem ps-testsuite Container in das lokale Verzeichnis zu kopieren.

[source]
----
docker cp ps-testsuite:/app/tiger-proxy.tgr .
----

== Geplante Änderungen

Hier eine Übersicht über die wichtigsten Änderungen, die wir planen. Wenn Sie hier Dinge vermissen oder Anregungen haben, melden Sie sich bitte bei uns!

* Einbau einer Test-REST-API in die Tiger-Testsuite, um eine bessere Integration in CI/CD-Pipelines zu ermöglichen.

== Fehlertickets
Wenn Sie ein Fehlerticket eröffnen wollen für dieses Repository, nutzen Sie bitte den gematik Service Desk unter
link:[https://service.gematik.de/servicedesk/customer/portal/26].

== Beiträge
Wenn Sie zu diesem Repository beitragen wollen, schauen Sie sich bitte die Datei link:[CONTRIBUTING.MD] an.

== Lizenz
Siehe link:[LICENSE]

== Kontakt
gematik GmbH: [OSPO@gematik.de](mailto:OSPO@gematik.de)
